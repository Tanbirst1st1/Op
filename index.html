<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Compressor + ImgBB Uploader</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      padding-top: 4.5rem;
    }
    .nav-link {
      cursor: pointer;
    }
    .hidden-section {
      display: none;
    }
    /* Drag-and-drop zone styles */
    #drop-zone {
      border: 2px dashed #6c757d;
      border-radius: 0.25rem;
      padding: 2rem;
      text-align: center;
      color: #6c757d;
      transition: background-color 0.2s, border-color 0.2s;
    }
    #drop-zone.hover {
      background-color: #f8f9fa;
      border-color: #495057;
    }
    #drop-zone input[type="file"] {
      display: none;
    }
    #drop-zone p {
      margin: 0;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand">ImgCompressApp</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarContent"
        aria-controls="navbarContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menu-items">
          <li class="nav-item">
            <span class="nav-link" data-target="home-section">Home</span>
          </li>
          <li class="nav-item">
            <span class="nav-link" data-target="upload-section">Upload</span>
          </li>
          <li class="nav-item">
            <span class="nav-link" data-target="login-section" id="menu-login">Login</span>
          </li>
          <li class="nav-item">
            <span class="nav-link" data-target="signup-section" id="menu-signup">Sign Up</span>
          </li>
          <li class="nav-item">
            <span class="nav-link hidden-section" data-target="files-section" id="menu-files">My Files</span>
          </li>
        </ul>
        <span class="navbar-text hidden-section" id="menu-logout">
          <span class="nav-link">Logout</span>
        </span>
      </div>
    </div>
  </nav>
  
  <!-- MAIN CONTAINER -->
  <main class="container">
    <!-- HOME -->
    <section id="home-section">
      <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
          <h1 class="display-5 fw-bold">Welcome to ImgCompressApp</h1>
          <p class="col-md-8 fs-4">
            Compress images in your browser and host them on ImgBB—no signup required.
          </p>
        </div>
      </div>
    </section>
  
    <!-- LOGIN -->
    <section id="login-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Login</h5>
            </div>
            <div class="card-body">
              <form id="login-form">
                <div class="mb-3">
                  <label for="login-username" class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="login-username"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="login-password" class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="login-password"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="login-error" class="text-danger mt-2" style="display: none;">
                  Invalid username or password.
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- SIGNUP -->
    <section id="signup-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Sign Up</h5>
            </div>
            <div class="card-body">
              <form id="signup-form">
                <div class="mb-3">
                  <label for="signup-username" class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="signup-username"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-password" class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-password-confirm" class="form-label"
                    >Confirm Password</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password-confirm"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-success w-100">Sign Up</button>
                <div id="signup-error" class="text-danger mt-2" style="display: none;">
                  <!-- Error messages injected here -->
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- UPLOAD (always visible) -->
    <section id="upload-section" class="mt-4">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Upload & Compress Image</h5>
            </div>
            <div class="card-body">
  
              <!-- Drag-and-Drop Zone -->
              <div id="drop-zone">
                <p>Drag & Drop your image here<br />or<br />Click to select (PNG/JPG)</p>
                <input
                  type="file"
                  id="image-file"
                  accept="image/png, image/jpeg"
                />
              </div>
  
              <div id="compression-options" class="mb-3 mt-3">
                <label class="form-label">Output Format</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="formatRadios"
                    id="format-webp"
                    value="webp"
                    checked
                  />
                  <label class="form-check-label" for="format-webp">
                    WebP (recommended)
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="formatRadios"
                    id="format-jpeg"
                    value="jpeg"
                  />
                  <label class="form-check-label" for="format-jpeg">
                    JPEG
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="formatRadios"
                    id="format-png"
                    value="png"
                  />
                  <label class="form-check-label" for="format-png">
                    PNG
                  </label>
                </div>
              </div>
  
              <button id="compress-upload-btn" class="btn btn-info w-100">
                Compress & Upload
              </button>
  
              <div id="upload-status" class="mt-4" style="display: none;">
                <p><strong>Original size:</strong> <span id="orig-size"></span></p>
                <p><strong>Compressed size:</strong> <span id="comp-size"></span></p>
                <p>
                  <strong>ImgBB Link:</strong>
                  <a href="#" id="imgbb-link" target="_blank">—</a>
                </p>
              </div>
  
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- MY FILES (visible only when logged in) -->
    <section id="files-section" class="hidden-section mt-4">
      <div class="row justify-content-center">
        <div class="col-md-10">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">My Uploaded Files</h5>
            </div>
            <div class="card-body">
              <table class="table table-striped" id="files-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Preview</th>
                    <th>Format</th>
                    <th>Size (KB)</th>
                    <th>ImgBB Link</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated via JS -->
                </tbody>
              </table>
              <div id="no-files-msg" class="text-muted" style="display: none;">
                You have not uploaded any files yet.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Squoosh (ESM) -->
  <script type="module">
    import { ImagePool } from "https://cdn.jsdelivr.net/npm/@squoosh/lib@0.7.2";
  
    // ————————————  CONFIG  ————————————
    // We'll load this from imgbb_api.txt at runtime
    let IMGBB_API_KEY = null;
    fetch("imgbb_api.txt")
      .then((res) => res.text())
      .then((text) => {
        IMGBB_API_KEY = text.trim();
      })
      .catch((err) => {
        console.error("Failed to load ImgBB API key:", err);
        alert("Error: could not load ImgBB API key. Make sure imgbb_api.txt is present.");
      });
  
    // Seed users (only if localStorage is empty)
    const seedUsers = [
      { username: "alice", password: "alice123" },
      { username: "bob", password: "bob123" },
    ];
    // ————————————  STATE  ————————————
    let currentUser = null;
  
    function initStorage() {
      if (!localStorage.getItem("users")) {
        localStorage.setItem("users", JSON.stringify(seedUsers));
      }
      if (!localStorage.getItem("images")) {
        localStorage.setItem("images", JSON.stringify([]));
      }
    }
    function getUsers() {
      return JSON.parse(localStorage.getItem("users")) || [];
    }
    function saveUsers(arr) {
      localStorage.setItem("users", JSON.stringify(arr));
    }
    function getImages() {
      return JSON.parse(localStorage.getItem("images")) || [];
    }
    function saveImages(arr) {
      localStorage.setItem("images", JSON.stringify(arr));
    }
  
    // ————————————  NAVIGATION / VIEW  ————————————
    const sections = {
      "home-section": document.getElementById("home-section"),
      "login-section": document.getElementById("login-section"),
      "signup-section": document.getElementById("signup-section"),
      // upload-section is always visible, so we don't hide it globally
      "files-section": document.getElementById("files-section"),
    };
    const menuLinks = document.querySelectorAll(".nav-link[data-target]");
    const loginMenuItem = document.getElementById("menu-login");
    const signupMenuItem = document.getElementById("menu-signup");
    const filesMenuItem = document.getElementById("menu-files");
    const logoutMenuItem = document.getElementById("menu-logout");
  
    function showSection(id) {
      // Hide all controllable sections first
      Object.values(sections).forEach((sec) => (sec.style.display = "none"));
      // Then show the requested one
      sections[id].style.display = "block";
    }
  
    menuLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const target = link.getAttribute("data-target");
        if (target === "logout") {
          doLogout();
        } else {
          showSection(target);
        }
        // Collapse navbar on mobile
        const bsCollapse = new bootstrap.Collapse(
          document.getElementById("navbarContent"),
          { toggle: false }
        );
        bsCollapse.hide();
      });
    });
  
    logoutMenuItem.addEventListener("click", () => {
      doLogout();
      const bsCollapse = new bootstrap.Collapse(
        document.getElementById("navbarContent"),
        { toggle: false }
      );
      bsCollapse.hide();
    });
  
    // ————————————  AUTH: SIGNUP ————————————
    const signupForm = document.getElementById("signup-form");
    const signupError = document.getElementById("signup-error");
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const uname = document.getElementById("signup-username").value.trim();
      const pwd = document.getElementById("signup-password").value;
      const pwd2 = document.getElementById("signup-password-confirm").value;
      signupError.style.display = "none";
  
      if (pwd !== pwd2) {
        signupError.textContent = "Passwords do not match.";
        signupError.style.display = "block";
        return;
      }
      const users = getUsers();
      if (users.some((u) => u.username === uname)) {
        signupError.textContent = "Username already exists.";
        signupError.style.display = "block";
        return;
      }
      users.push({ username: uname, password: pwd });
      saveUsers(users);
      alert("Signup successful! You can now log in.");
      signupForm.reset();
      showSection("login-section");
    });
  
    // ————————————  AUTH: LOGIN ————————————
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const uname = document.getElementById("login-username").value.trim();
      const pwd = document.getElementById("login-password").value;
      loginError.style.display = "none";
  
      const users = getUsers();
      const found = users.find((u) => u.username === uname && u.password === pwd);
      if (!found) {
        loginError.style.display = "block";
        return;
      }
      currentUser = found;
      loginForm.reset();
      postLoginUI();
    });
  
    function postLoginUI() {
      loginMenuItem.classList.add("hidden-section");
      signupMenuItem.classList.add("hidden-section");
      filesMenuItem.classList.remove("hidden-section");
      logoutMenuItem.classList.remove("hidden-section");
      showSection("upload-section");
      populateFilesTable();
    }
  
    // ————————————  LOGOUT ————————————
    function doLogout() {
      currentUser = null;
      loginMenuItem.classList.remove("hidden-section");
      signupMenuItem.classList.remove("hidden-section");
      filesMenuItem.classList.add("hidden-section");
      logoutMenuItem.classList.add("hidden-section");
      showSection("home-section");
    }
  
    // ————————————  DRAG-&-DROP + UPLOAD ————————————
    const dropZone = document.getElementById("drop-zone");
    const imageInput = document.getElementById("image-file");
    const compressBtn = document.getElementById("compress-upload-btn");
    const uploadStatus = document.getElementById("upload-status");
    const origSizeEl = document.getElementById("orig-size");
    const compSizeEl = document.getElementById("comp-size");
    const imgbbLinkEl = document.getElementById("imgbb-link");
  
    // Highlight on drag over
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("hover");
    });
    dropZone.addEventListener("dragleave", (e) => {
      dropZone.classList.remove("hover");
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        imageInput.files = e.dataTransfer.files;
      }
    });
    // Click → open file picker
    dropZone.addEventListener("click", () => {
      imageInput.click();
    });
    // If user selects via file picker, we can show the file name or just leave it
    imageInput.addEventListener("change", () => {
      // (no special UI needed; users know it’s selected because they clicked/dragged)
    });
  
    compressBtn.addEventListener("click", async () => {
      if (!IMGBB_API_KEY) {
        alert("ImgBB API key is not loaded yet. Please try again in a moment.");
        return;
      }
      const files = imageInput.files;
      if (!files || files.length === 0) {
        alert("Please drag & drop or select an image file first.");
        return;
      }
      const file = files[0];
      const format = document.querySelector(
        'input[name="formatRadios"]:checked'
      ).value;
  
      // Show original size
      const origSizeKB = (file.size / 1024).toFixed(2);
      origSizeEl.textContent = `${origSizeKB} KB`;
  
      // Compress via Squoosh
      const imagePool = new ImagePool();
      const image = imagePool.ingestImage(await file.arrayBuffer());
      await image.encode([
        {
          preset:
            format === "webp"
              ? "webp"
              : format === "jpeg"
              ? "mozjpeg"
              : "oxipng",
          ...(format === "jpeg"
            ? { quality: 75 }
            : format === "webp"
            ? { quality: 75 }
            : {}),
        },
      ]);
      const { binary } = await image.encodedWith[0].arrayBuffer();
      await imagePool.close();
  
      const compressedBlob = new Blob([binary], { type: `image/${format}` });
      const compSizeKB = (compressedBlob.size / 1024).toFixed(2);
      compSizeEl.textContent = `${compSizeKB} KB`;
  
      // Convert to Base64
      const base64str = await new Promise((res) => {
        const reader = new FileReader();
        reader.onloadend = () => res(reader.result.split(",")[1]);
        reader.readAsDataURL(compressedBlob);
      });
  
      // Upload to ImgBB
      const formData = new FormData();
      formData.append("key", IMGBB_API_KEY);
      formData.append("image", base64str);
  
      const response = await fetch("https://api.imgbb.com/1/upload", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      if (result.success) {
        const url = result.data.url;
        imgbbLinkEl.href = url;
        imgbbLinkEl.textContent = url;
        uploadStatus.style.display = "block";
  
        // If logged in, store metadata
        if (currentUser) {
          const imgArr = getImages();
          imgArr.push({
            username: currentUser.username,
            format: format,
            sizeKB: compSizeKB,
            url: url,
          });
          saveImages(imgArr);
          // Refresh “My Files” if currently visible
          if (!filesMenuItem.classList.contains("hidden-section")) {
            populateFilesTable();
          }
        }
      } else {
        alert("Upload to ImgBB failed. Try again.");
      }
      // Reset file input for next time
      imageInput.value = "";
    });
  
    // ————————————  MY FILES TABLE ————————————
    const filesTableBody = document.querySelector("#files-table tbody");
    const noFilesMsg = document.getElementById("no-files-msg");
  
    function populateFilesTable() {
      if (!currentUser) return;
      const allImages = getImages().filter(
        (img) => img.username === currentUser.username
      );
      filesTableBody.innerHTML = "";
      if (allImages.length === 0) {
        noFilesMsg.style.display = "block";
        return;
      }
      noFilesMsg.style.display = "none";
      allImages.forEach((img, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>
            <img src="${img.url}" alt="Preview" style="max-width: 100px; max-height: 60px;" />
          </td>
          <td>${img.format.toUpperCase()}</td>
          <td>${img.sizeKB}</td>
          <td><a href="${img.url}" target="_blank">View</a></td>
        `;
        filesTableBody.appendChild(tr);
      });
    }
  
    // ————————————  ON LOAD ————————————
    window.addEventListener("DOMContentLoaded", () => {
      initStorage();
      showSection("home-section");
    });
  </script>
  
  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>
