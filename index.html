<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Compressor + ImgBB Uploader</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    /* Small custom tweaks */
    body {
      padding-top: 4.5rem;
    }
    .nav-link {
      cursor: pointer;
    }
    .hidden-section {
      display: none;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand">ImgCompressApp</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarContent"
        aria-controls="navbarContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menu-items">
          <li class="nav-item">
            <span class="nav-link" data-target="home-section">Home</span>
          </li>
          <li class="nav-item">
            <span class="nav-link" data-target="login-section" id="menu-login">Login</span>
          </li>
          <li class="nav-item">
            <span class="nav-link" data-target="signup-section" id="menu-signup">Sign Up</span>
          </li>
          <li class="nav-item">
            <span class="nav-link hidden-section" data-target="upload-section" id="menu-upload">Upload</span>
          </li>
          <li class="nav-item">
            <span class="nav-link hidden-section" data-target="files-section" id="menu-files">My Files</span>
          </li>
        </ul>
        <span class="navbar-text hidden-section" id="menu-logout">
          <span class="nav-link">Logout</span>
        </span>
      </div>
    </div>
  </nav>
  
  <!-- MAIN CONTAINER -->
  <main class="container">
    <!-- HOME -->
    <section id="home-section">
      <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
          <h1 class="display-5 fw-bold">Welcome to ImgCompressApp</h1>
          <p class="col-md-8 fs-4">
            Compress your images in the browser and host them on ImgBB, completely free.
          </p>
        </div>
      </div>
    </section>
  
    <!-- LOGIN -->
    <section id="login-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Login</h5>
            </div>
            <div class="card-body">
              <form id="login-form">
                <div class="mb-3">
                  <label for="login-username" class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="login-username"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="login-password" class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="login-password"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="login-error" class="text-danger mt-2" style="display: none;">
                  Invalid username or password.
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- SIGNUP -->
    <section id="signup-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Sign Up</h5>
            </div>
            <div class="card-body">
              <form id="signup-form">
                <div class="mb-3">
                  <label for="signup-username" class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="signup-username"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-password" class="form-label">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-password-confirm" class="form-label"
                    >Confirm Password</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password-confirm"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-success w-100">Sign Up</button>
                <div id="signup-error" class="text-danger mt-2" style="display: none;">
                  <!-- Error messages injected here -->
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- UPLOAD (visible only when logged in) -->
    <section id="upload-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Upload & Compress Image</h5>
            </div>
            <div class="card-body">
              <form id="upload-form">
                <div class="mb-3">
                  <label for="image-file" class="form-label">Select Image (PNG/JPG)</label>
                  <input
                    class="form-control"
                    type="file"
                    id="image-file"
                    accept="image/png, image/jpeg"
                    required
                  />
                </div>
                <div id="compression-options" class="mb-3">
                  <label class="form-label">Output Format</label>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="formatRadios"
                      id="format-webp"
                      value="webp"
                      checked
                    />
                    <label class="form-check-label" for="format-webp">
                      WebP (recommended)
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="formatRadios"
                      id="format-jpeg"
                      value="jpeg"
                    />
                    <label class="form-check-label" for="format-jpeg">
                      JPEG
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="formatRadios"
                      id="format-png"
                      value="png"
                    />
                    <label class="form-check-label" for="format-png">
                      PNG
                    </label>
                  </div>
                </div>
                <button type="submit" class="btn btn-info w-100">Compress & Upload</button>
              </form>
  
              <div id="upload-status" class="mt-4" style="display: none;">
                <p><strong>Original size:</strong> <span id="orig-size"></span></p>
                <p><strong>Compressed size:</strong> <span id="comp-size"></span></p>
                <p><strong>ImgBB Link:</strong> <a href="#" id="imgbb-link" target="_blank">—</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- MY FILES (visible only when logged in) -->
    <section id="files-section" class="hidden-section">
      <div class="row justify-content-center">
        <div class="col-md-10">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">My Uploaded Files</h5>
            </div>
            <div class="card-body">
              <table class="table table-striped" id="files-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Preview</th>
                    <th>Format</th>
                    <th>Size (KB)</th>
                    <th>ImgBB Link</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated via JS -->
                </tbody>
              </table>
              <div id="no-files-msg" class="text-muted" style="display: none;">
                You have not uploaded any files yet.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Squoosh (ESM) -->
  <script type="module">
    import { ImagePool } from "https://cdn.jsdelivr.net/npm/@squoosh/lib@0.7.2";
  
    // ————————————  CONFIG  ————————————
    const IMGBB_API_KEY = "e6695fe8544f576de5499c876dc11d7b"; // ← Replace with your ImgBB API key
  
    // Seed users (only if localStorage is empty)
    const seedUsers = [
      { username: "alice", password: "alice123" },
      { username: "bob", password: "bob123" },
    ];
    // Structure: { username: string, password: string }
  
    // ————————————  STATE  ————————————
    let currentUser = null; // holds { username, password }
    // We’ll store arrays of users and images in localStorage as JSON:
    //   localStorage["users"] = JSON.stringify([{ username, password }, ...])
    //   localStorage["images"] = JSON.stringify([{ username, format, sizeKB, url }, ...])
  
    // ————————————  INIT  ————————————
    function initStorage() {
      if (!localStorage.getItem("users")) {
        localStorage.setItem("users", JSON.stringify(seedUsers));
      }
      if (!localStorage.getItem("images")) {
        localStorage.setItem("images", JSON.stringify([]));
      }
    }
  
    function getUsers() {
      return JSON.parse(localStorage.getItem("users")) || [];
    }
    function saveUsers(arr) {
      localStorage.setItem("users", JSON.stringify(arr));
    }
  
    function getImages() {
      return JSON.parse(localStorage.getItem("images")) || [];
    }
    function saveImages(arr) {
      localStorage.setItem("images", JSON.stringify(arr));
    }
  
    // ————————————  NAVIGATION / VIEW  ————————————
    const sections = {
      "home-section": document.getElementById("home-section"),
      "login-section": document.getElementById("login-section"),
      "signup-section": document.getElementById("signup-section"),
      "upload-section": document.getElementById("upload-section"),
      "files-section": document.getElementById("files-section"),
    };
    const menuLinks = document.querySelectorAll(".nav-link[data-target]");
    const loginMenuItem = document.getElementById("menu-login");
    const signupMenuItem = document.getElementById("menu-signup");
    const uploadMenuItem = document.getElementById("menu-upload");
    const filesMenuItem = document.getElementById("menu-files");
    const logoutMenuItem = document.getElementById("menu-logout");
  
    function showSection(id) {
      Object.values(sections).forEach((sec) => (sec.style.display = "none"));
      sections[id].style.display = "block";
    }
  
    menuLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const target = link.getAttribute("data-target");
        if (target === "logout") {
          doLogout();
        } else {
          showSection(target);
        }
      });
    });
  
    // On small screens, if a menu link is clicked, collapse the navbar
    const bsCollapse = new bootstrap.Collapse(
      document.getElementById("navbarContent"),
      { toggle: false }
    );
    menuLinks.forEach((link) => {
      link.addEventListener("click", () => {
        bsCollapse.hide();
      });
    });
  
    logoutMenuItem.addEventListener("click", () => {
      doLogout();
      bsCollapse.hide();
    });
  
    // ————————————  AUTH: SIGNUP ————————————
    const signupForm = document.getElementById("signup-form");
    const signupError = document.getElementById("signup-error");
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const uname = document.getElementById("signup-username").value.trim();
      const pwd = document.getElementById("signup-password").value;
      const pwd2 = document.getElementById("signup-password-confirm").value;
      signupError.style.display = "none";
  
      if (pwd !== pwd2) {
        signupError.textContent = "Passwords do not match.";
        signupError.style.display = "block";
        return;
      }
      const users = getUsers();
      if (users.some((u) => u.username === uname)) {
        signupError.textContent = "Username already exists.";
        signupError.style.display = "block";
        return;
      }
      users.push({ username: uname, password: pwd });
      saveUsers(users);
      alert("Signup successful! You can now log in.");
      signupForm.reset();
      // After signup, redirect to Login
      showSection("login-section");
    });
  
    // ————————————  AUTH: LOGIN ————————————
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const uname = document.getElementById("login-username").value.trim();
      const pwd = document.getElementById("login-password").value;
      loginError.style.display = "none";
  
      const users = getUsers();
      const found = users.find((u) => u.username === uname && u.password === pwd);
      if (!found) {
        loginError.style.display = "block";
        return;
      }
      // Successful login
      currentUser = found;
      loginForm.reset();
      postLoginUI();
    });
  
    function postLoginUI() {
      // Show/Hide menu items
      loginMenuItem.classList.add("hidden-section");
      signupMenuItem.classList.add("hidden-section");
      uploadMenuItem.classList.remove("hidden-section");
      filesMenuItem.classList.remove("hidden-section");
      logoutMenuItem.classList.remove("hidden-section");
      // Go to upload page by default
      showSection("upload-section");
      populateFilesTable();
    }
  
    // ————————————  LOGOUT ————————————
    function doLogout() {
      currentUser = null;
      loginMenuItem.classList.remove("hidden-section");
      signupMenuItem.classList.remove("hidden-section");
      uploadMenuItem.classList.add("hidden-section");
      filesMenuItem.classList.add("hidden-section");
      logoutMenuItem.classList.add("hidden-section");
      showSection("home-section");
    }
  
    // ————————————  UPLOAD & COMPRESS ————————————
    const uploadForm = document.getElementById("upload-form");
    const imageInput = document.getElementById("image-file");
    const uploadStatus = document.getElementById("upload-status");
    const origSizeEl = document.getElementById("orig-size");
    const compSizeEl = document.getElementById("comp-size");
    const imgbbLinkEl = document.getElementById("imgbb-link");
  
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const file = imageInput.files[0];
      if (!file) return;
  
      uploadStatus.style.display = "none";
      const format = document.querySelector(
        'input[name="formatRadios"]:checked'
      ).value;
  
      // 1. Show original size
      const origSizeKB = (file.size / 1024).toFixed(2);
      origSizeEl.textContent = `${origSizeKB} KB`;
  
      // 2. Compress using Squoosh
      const imagePool = new ImagePool();
      const image = imagePool.ingestImage(await file.arrayBuffer());
      await image.encode([
        {
          preset: format === "webp" ? "webp" : format === "jpeg" ? "mozjpeg" : "oxipng",
          ...(format === "jpeg"
            ? { quality: 75 }
            : format === "webp"
            ? { quality: 75 }
            : {}),
        },
      ]);
      const { binary } = await image.encodedWith[0].arrayBuffer();
      await imagePool.close();
  
      const compressedBlob = new Blob([binary], { type: `image/${format}` });
      const compSizeKB = (compressedBlob.size / 1024).toFixed(2);
      compSizeEl.textContent = `${compSizeKB} KB`;
  
      // 3. Convert Blob → Base64
      const base64str = await new Promise((res) => {
        const reader = new FileReader();
        reader.onloadend = () => res(reader.result.split(",")[1]);
        reader.readAsDataURL(compressedBlob);
      });
  
      // 4. Send to ImgBB
      const formData = new FormData();
      formData.append("key", IMGBB_API_KEY);
      formData.append("image", base64str);
  
      const response = await fetch("https://api.imgbb.com/1/upload", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      if (result.success) {
        const url = result.data.url;
        imgbbLinkEl.href = url;
        imgbbLinkEl.textContent = url;
        uploadStatus.style.display = "block";
  
        // 5. Store metadata in localStorage (“images” JSON)
        const imgArr = getImages();
        imgArr.push({
          username: currentUser.username,
          format: format,
          sizeKB: compSizeKB,
          url: url,
        });
        saveImages(imgArr);
  
        // Refresh “My Files” table if visible
        if (!filesMenuItem.classList.contains("hidden-section")) {
          populateFilesTable();
        }
      } else {
        alert("Upload to ImgBB failed. Try again.");
      }
      uploadForm.reset();
    });
  
    // ————————————  MY FILES TABLE ————————————
    const filesTableBody = document.querySelector("#files-table tbody");
    const noFilesMsg = document.getElementById("no-files-msg");
  
    function populateFilesTable() {
      if (!currentUser) return;
      const allImages = getImages().filter(
        (img) => img.username === currentUser.username
      );
      filesTableBody.innerHTML = "";
      if (allImages.length === 0) {
        noFilesMsg.style.display = "block";
        return;
      }
      noFilesMsg.style.display = "none";
      allImages.forEach((img, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>
            <img src="${img.url}" alt="Preview" style="max-width: 100px; max-height: 60px;" />
          </td>
          <td>${img.format.toUpperCase()}</td>
          <td>${img.sizeKB}</td>
          <td><a href="${img.url}" target="_blank">View</a></td>
        `;
        filesTableBody.appendChild(tr);
      });
    }
  
    // ————————————  ON LOAD ————————————
    window.addEventListener("DOMContentLoaded", () => {
      initStorage();
      showSection("home-section");
    });
  </script>
  
  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>
